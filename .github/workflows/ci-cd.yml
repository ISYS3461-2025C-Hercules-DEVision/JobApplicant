name: CI + CD (Build/Test + Push to ECR)

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
  ECR_NAMESPACE: ja-devision-platform

jobs:
  # -----------------------------
  # CI: Build (and optional test)
  # Runs on PRs and pushes
  # -----------------------------
  ci:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: api-gateway
            folder: backend/api-gateway
            type: java
          - name: applicant
            folder: backend/applicant
            type: java
          - name: authentication
            folder: backend/authentication
            type: java
          - name: discovery-server
            folder: backend/discovery-server
            type: java
          - name: admin
            folder: backend/admin
            type: java
          - name: frontend
            folder: frontend
            type: node

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---- Java setup ----
      - name: Setup Java 21
        if: matrix.type == 'java'
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "maven"

      - name: Setup Maven
        if: matrix.type == 'java'
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: 3.9.9

      - name: Build Java service (skip tests)
        if: matrix.type == 'java'
        working-directory: ./${{ matrix.folder }}
        run: mvn -B -DskipTests clean package

      # ---- Node setup ----
      - name: Setup Node.js
        if: matrix.type == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ./${{ matrix.folder }}/package-lock.json

      - name: Build frontend
        if: matrix.type == 'node'
        working-directory: ./${{ matrix.folder }}
        run: |
          npm ci
          npm run build

  # -----------------------------
  # CD: Build Docker images + push to ECR
  # Runs ONLY on push to main
  # -----------------------------
  cd:
    needs: ci
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - folder: backend/api-gateway
            repo: api-gateway
          - folder: backend/applicant
            repo: applicant-service
          - folder: backend/authentication
            repo: authentication-service
          - folder: backend/discovery-server
            repo: discovery-server
          - folder: backend/admin
            repo: admin
          - folder: frontend
            repo: front-end

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      # ✅ Push Redis official image to ECR (ONLY ONCE PER WORKFLOW RUN)
      - name: Push Redis image to ECR
        if: matrix.repo == 'api-gateway'
        run: |
          set -e
          SHA_TAG="${GITHUB_SHA::7}"
          IMAGE_URI="${ECR_REGISTRY}/${ECR_NAMESPACE}/redis"

          echo "Pulling official redis:7-alpine"
          docker pull redis:7-alpine

          echo "Tagging for ECR: ${IMAGE_URI}"
          docker tag redis:7-alpine ${IMAGE_URI}:latest
          docker tag redis:7-alpine ${IMAGE_URI}:${SHA_TAG}

          echo "Pushing to ECR..."
          docker push ${IMAGE_URI}:latest
          docker push ${IMAGE_URI}:${SHA_TAG}

          echo "✅ Done: ${IMAGE_URI} pushed as latest and ${SHA_TAG}"

      # ✅ Build & Push project Docker images (backend + frontend)
      - name: Build & Push Docker image
        run: |
          set -e
          SHA_TAG="${GITHUB_SHA::7}"
          IMAGE_URI="${ECR_REGISTRY}/${ECR_NAMESPACE}/${{ matrix.repo }}"

          echo "Building from folder: ${{ matrix.folder }}"
          echo "Pushing to: ${IMAGE_URI}"

          docker build \
            -t ${IMAGE_URI}:latest \
            -t ${IMAGE_URI}:${SHA_TAG} \
            ./${{ matrix.folder }}

          docker push ${IMAGE_URI}:latest
          docker push ${IMAGE_URI}:${SHA_TAG}

          echo "✅ Done: ${IMAGE_URI} pushed as latest and ${SHA_TAG}"
